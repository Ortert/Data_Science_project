# Oписание проекта - Разработка системы предупреждения аварий на каршеринге.

Исследовать данные каршеринговой компании

## Данные

Согласно документации к данным, данные находятся в БД и она содержит следующие таблицы:

- collisions — общая информация о ДТП. Например, где оно произошло и когда. Имеет уникальный case_id.
- parties — информация об участниках ДТП. Имеет неуникальный case_id, который сопоставляется с соответствующим ДТП в таблице collisions. Каждая строка здесь описывает одну из сторон, участвующих в ДТП. Если столкнулись две машины, в этой таблице должно быть две строки с совпадением case_id. Если нужен уникальный идентификатор, это case_id and party_number.
- vehicles — информация о пострадавших машинах. Имеет неуникальные case_id и неуникальные party_number, которые сопоставляются с таблицей collisions и таблицей parties. Если нужен уникальный идентификатор, это case_id and party_number.

## Задача

Построить систему предупреждения о ДТП по выбранному маршруту движения. И понять возможно ли вообще создание такой системы для оценки риска при выдаче авто.

## Используемые библиотеки
*pandas*, *matplotlib*, *seaborn*, *numpy*, *optuna*, *sqlalchemy*, *sklearn*, *phik*, *lightgbm*, *catboost*, *SHAP*

## Вывод

Выполнено подключение к базе данных, содержащей необходимую для проведения исследования информацию. Проверена корректность вывода данных при обращении к базе.

С помощью SQL-запросов выведены тестовые выборки таблиц  vehicles, parties, collisions:
- проверено наличие набора данных для всех таблиц: все заявленные данные содержатся в таблицах
- проверено соответствие количества таблиц условию задачи: количество соответствует
- проверено наличие общего ключа для связи таблиц: общий ключ в наличии, таблицы объединяются корректно.

В рамках статистического анализа:
- выполнено исследование, в какие месяцы происходит наибольшее количество аварий - больше всего ДТП происходит в превые 5 месяцев года, с января по май (включительно), достигая своего пика в марте - 139_581 ДТП, далее с июня по декабрь (включительно) следует заметное снижение количества транспортных происшествий, достигающее свой минимум в июле - 102_594 ДТП.
- поставлено шесть следующих аналитических задач:
1. Автомобили с каким типом КПП попадают в ДТП чаще?
2. Какой самый распространенный тип ДТП встречается в Лос-Анджелесе?
3. На каком направлении движения (direction) чаще всего происходят аварии на перекрестках?
4. Автомобили какого возраста чаще всего получают фатальные повреждения?
5. В каком состоянии трезвости водители являются виновниками ДТП чаще всего?
6. На автомобили с каким типом кузова приходится самая высокая средняя страховая выплата?
- реализованы 4 и 6 задачи из списка выше. 
Задача 4 - фатальные повреждения чаще всего получают машины 3, 4 и 5 лет, что связано с большим количеством машин такого возраста на дорогах.
Задача 6 - самые высокие средние страховые выплаты приходятся на автомобили в кузове coupe, самые низкие на авто в кузове minivan. Такое распределение возможно обусловлено тем фактом, что автомобили в кузове coupe часто имеют большую мощность и пользуются популярностью у молодежи, что приводит к повышенному количеству ДТП среди автомобилей данного кузова. Автомобили же в кузове minivan как правило не обладают выдающейся динамикой и как правило популярны у более возрастной категории. 

В рамках создания модели для оценки водительского риска:
1. Cформирована выборка в соответствии с ТЗ Заказчика:
- использовать данные по ДТП только за 2012 год,
- исключить из выборки ДТП, результатом которого являлось повреждение типа "царапина"
- использовать только те данные, где участником ДТП являлся автомобиль

2. Со стороны Исполнителя исключены из входных признаков те данные, которые были получены уже после свершения дорожно-транспортного происшетсвия, а именно:
- 'collision_damage'
- 'party_count'
- 'primary_collision_factor'
- 'pcf_violation_category'
- 'type_of_collision'
- 'motor_vehicle_involved_with'
- 'party_type'
- 'insurance_premium'
- 'party_number'
По итогу обозначенных выше требований был выполнен  SQL-запрос к БД на формирование финальной выборки, путем объединения таблицы vehicle, parties и collisions по ключу case_id и применения необходимой фильтрации.

4. Проведена предварительная обработка полученного датасета: устранены пропущенные значения, путем замены таковых на заглушку "unknown", а также путем удаления объектов с отсутствующими данными, также выполнено удаление явных дубликатов.

3. Проведен исследовательский анализ распределения значения входяших параметров. Выявлены и удалены следующие аномалии:
- из столбца 'distance' (Расстояние от главной дороги)  удалено значение 1_584_000 метров
- из столбца 'vehicle_age' (Возраст автомобиля) удалено значение 161 год

4. Входящие параметры проверены на мультиколлинеарность с помощью матрицы корреляции - параметров с высокой корреляцией не выявлено.

5. Сформированы тренировочная и тестовая выборки для последуюшей работы с моделями

В рамках поиска лучшей модели и проверки работы модели:
1. С помощью пайплайна подобраны наилучшие сочетания гиперпараметров для следующих моделей:
- LogisticRegression()
- KNeighborsClassifier() 
- RandomForestClassifier()
- LGBMClassifier()
- CatBoostClassifier()  

В качестве кодировщика использовался OneHotEncoding, масштабирование выполнялось с помощью StandardScaler(), MinMaxScaler() и RobustScaler()

2. По итогу работы пайплайнов, наилучшие метрики показали две модели:
- LGBMClassifier()
- CatBoostClassifier()
Разница в значениях метрик этих моделей крайне незначительна, какие то метрики лучше у одной модели, какие то у другой. 
Чтобы финально определиться с лучшей моделью, сравнивались значения True Positive - насколько хорошо модели определили объекты с меткой "1" - клиента, который попадет в ДТП. Данный параметр имеет наибольшее значение в результате работы CatBoostClassifier(), что подтверждается более высокой метрикой recall. Соответственно результаты работы данной модели были приняты как наилучшие.

 Выполнен анализ важности входящих признаков при работе лучшей модели CatBoostClassifier.
Наиболее важными признаками в результате работы модели оказались:
1. Степень трезвости водителя:
- 'had_not_been_drinking'
- 'had_been drinking_under_influence
2. Возраст автомобиля 'vehicle_age'
3. Тип кузова автомобиля:
- 'sedan'
- 'coupe'


Выведены графики зависимости важных признаков и целевого признака:

- по степени трезвости: трезвое состояние водителя ('had not been drinking) заметно повышает вероятность не стать виновником ДТП, в то время как состояние опьянения ('had been drinking, under influence') практически гарантированно ведет к попаданию в ДТП в качестве виновника, в связи с чем можно дать рекомендацию о необходимости конроля состояния трезвости водителя, перед началом выполнения поездки (например с помощью установки алкотетсера в автомобиле)

- по возрасту автомобиля: чаще всего виновниками ДТП явдяются водители автомобилей возрастом 2, 3 и 4 года. Точную причину такой зависимости установить не удалось. Требуются дополнительные исследования

- по типу кузова автомобиля: водители автомобилей в кузове coupe с большей вероятнстью становятся виновниками ДТП. Возможно это обусловлено тем фактом, что автомобили в кузове coupe часто имеют большую мощность и пользуются популярностью у молодежи, что приводит к повышенному количеству ДТП среди автомобилей данного кузова. Можно рекомендовать установление дополнительных требований к водителям данного типа кузова (например повышение возраста водителей, начиная с которого предоставляется доступ или повышение величины водительского стажа)

По итогу выполненных исследований можно сделать вывод о том, что предоставленных данных для определения виновника ДТП с высокой вероятностью недостаточно. Для улучшения прогноза хотелось бы получить следующие сведения:
- является ли объект автомобилем каршеринга;
- каков возраст водителя;
- каков водительский стаж водителя;
- как часто водитель нарушает ПДД;
- уровень агрессивности вождения водителя (резки старты/торможения/перестроения
- количество поломок тормозной системы автомобиля
- количество поломок рулевой системы автомобиля
